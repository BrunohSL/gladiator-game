<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Making your first Phaser 3 Game - Part 5</title>
        <script src="./phaser.min.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>
        <script type="text/javascript">
            var config = {
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                physics: {
                    default: 'arcade',
                    arcade: {
                        debug: true
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            var player;
            var cursors;
            var canEnter = false;

            var actionButton;

            var playerSpeed = 220;
            var battle_door;
            var equipment_door;
            var magic_door;
            var potion_door;
            var enchantment_door;

            var game = new Phaser.Game(config);

            function preload ()
            {
                this.load.spritesheet('dude', './src/assets/dude.png',{
                    frameWidth: 32,
                    frameHeight: 48
                });

                this.load.image("tiles", "./src/assets/atlas.png");
                this.load.tilemapTiledJSON("map", "./src/assets/mainCity.json");
            }

            function create ()
            {
                const map = this.make.tilemap({ key: "map" });

                // Parameters are the name you gave the tileset in Tiled and then the key of the tileset image in
                // Phaser's cache (i.e. the name you used in preload)
                const tileset = map.addTilesetImage("newTileset", "tiles");

                // Parameters: layer name (or index) from Tiled, tileset, x, y
                const background = map.createStaticLayer("background", tileset, 0, 0);
                battle_door = map.createStaticLayer("battle_door", tileset, 0, 0);
                equipment_door = map.createStaticLayer("equipment_door", tileset, 0, 0);
                magic_door = map.createStaticLayer("magic_door", tileset, 0, 0);
                potion_door = map.createStaticLayer("potion_door", tileset, 0, 0);
                enchantment_door = map.createStaticLayer("enchantment_door", tileset, 0, 0);
                const scenario = map.createStaticLayer("scenario", tileset, 0, 0);

                // ----------------------------------------------------

                player = this.physics.add.sprite(100, 450, 'dude');
                player.setCollideWorldBounds(true);

                // ----------------------------------------------------

                cursors = this.input.keyboard.createCursorKeys();
                actionButton = this.input.keyboard.addKey('SPACE');

                // ----------------------------------------------------

                scenario.setCollisionByProperty({ collision: true});
                background.setCollisionByProperty({ collision: true});
                player.setCollideWorldBounds(true);

                this.physics.add.collider(player, scenario);
                this.physics.add.collider(player, background);

                // ----------------------------------------------------

                // this.anims.create({
                //     key: 'left',
                //     frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
                //     frameRate: 10,
                //     repeat: -1
                // });

                // this.anims.create({
                //     key: 'turn',
                //     frames: [ { key: 'dude', frame: 4 } ],
                //     frameRate: 20
                // });

                // this.anims.create({
                //     key: 'right',
                //     frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                //     frameRate: 10,
                //     repeat: -1
                // });

                // ----------------------------------------------------
            }

            function update ()
            {
                var cursors = this.input.keyboard.createCursorKeys();

                // Stop any previous movement from the last frame
                player.body.setVelocity(0);

                // Horizontal movement
                if (cursors.left.isDown) {
                    player.body.setVelocityX(-playerSpeed);
                } else if (cursors.right.isDown) {
                    player.body.setVelocityX(playerSpeed);
                }

                // Vertical movement
                if (cursors.up.isDown) {
                    player.body.setVelocityY(-playerSpeed);
                } else if (cursors.down.isDown) {
                    player.body.setVelocityY(playerSpeed);
                }

                var tile = battle_door.getTileAtWorldXY(player.x, player.y);
                if (tile) {
                // if (tile.index) {
                    // console.log(tile);
                    canEnter = true;
                    // console.log("overlap");
                }

                if (canEnter === true && actionButton.isDown) {
                    console.log(tile);
                    console.log("Entrou");
                }

                // Normalize and scale the velocity so that player can't move faster along a diagonal
                player.body.velocity.normalize().scale(playerSpeed);
            }
        </script>
    </body>
</html>
