<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Making your first Phaser 3 Game - Part 5</title>
        <script src="./phaser.min.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>
        <!-- <script type="text/javascript" src="./index.js"></script> -->
        <script type="text/javascript">
            var config = {
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                physics: {
                    default: 'arcade',
                    arcade: {
                        // gravity: { y: 300 },
                        debug: true
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            var player;
            // var stars;
            // var platforms;
            var cursors;
            // var score = 0;
            // var scoreText;

            var playerSpeed = 220;
            var houseDoor;;

            var game = new Phaser.Game(config);

            function preload ()
            {
                this.load.spritesheet('dude', './src/assets/dude.png',{
                    frameWidth: 32,
                    frameHeight: 48
                });

                this.load.image("tiles", "./src/assets/atlas.png");
                this.load.tilemapTiledJSON("map", "./src/assets/mainCity.json");
            }

            function create ()
            {
                const map = this.make.tilemap({ key: "map" });

                // Parameters are the name you gave the tileset in Tiled and then the key of the tileset image in
                // Phaser's cache (i.e. the name you used in preload)
                const tileset = map.addTilesetImage("newTileset", "tiles");

                // Parameters: layer name (or index) from Tiled, tileset, x, y
                const background = map.createStaticLayer("background", tileset, 0, 0);
                const door = map.createStaticLayer("door", tileset, 0, 0);
                const scenario = map.createStaticLayer("scenario", tileset, 0, 0);
                // const aboveLayer = map.createStaticLayer("Above Player", tileset, 0, 0);

                console.log(map);

                // /* houseDoor =  */map.findObject(door, function(e) {
                //     houseDoor = e;
                //     console.log(e);
                // });

                // ----------------------------------------------------

                player = this.physics.add.sprite(100, 450, 'dude');
                player.setCollideWorldBounds(true);

                // ----------------------------------------------------

                cursors = this.input.keyboard.createCursorKeys();

                // ----------------------------------------------------

                scenario.setCollisionByProperty({ collision: true});
                // door.setCollisionByProperty({ collision: true});
                background.setCollisionByProperty({ collision: true});
                player.setCollideWorldBounds(true);

                this.physics.add.collider(player, scenario);
                this.physics.add.collider(player, background);

                // ----------------------------------------------------

                // this.anims.create({
                //     key: 'left',
                //     frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
                //     frameRate: 10,
                //     repeat: -1
                // });

                // this.anims.create({
                //     key: 'turn',
                //     frames: [ { key: 'dude', frame: 4 } ],
                //     frameRate: 20
                // });

                // this.anims.create({
                //     key: 'right',
                //     frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                //     frameRate: 10,
                //     repeat: -1
                // });

                // ----------------------------------------------------

                // scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

                // this.physics.add.collider(player, platforms);
                // this.physics.add.collider(stars, platforms);

                // this.physics.add.overlap(player, stars, collectStar, null, this);
            }

            function update ()
            {
                var cursors = this.input.keyboard.createCursorKeys();

                // Stop any previous movement from the last frame
                player.body.setVelocity(0);

                // Horizontal movement
                if (cursors.left.isDown) {
                    player.body.setVelocityX(-playerSpeed);
                } else if (cursors.right.isDown) {
                    player.body.setVelocityX(playerSpeed);
                }

                // Vertical movement
                if (cursors.up.isDown) {
                    player.body.setVelocityY(-playerSpeed);
                } else if (cursors.down.isDown) {
                    player.body.setVelocityY(playerSpeed);
                }
                console.log(this.physics.add.overlap(player, door, null, null, this));
                // if (true == true) {
                //     console.log("");
                // }

                // Normalize and scale the velocity so that player can't move faster along a diagonal
                player.body.velocity.normalize().scale(playerSpeed);
            }

            // function collectStar (player, star) {
            //     star.disableBody(true, true);

            //     score += 10;
            //     scoreText.setText('Score: ' + score);
            // }
        </script>
    </body>
</html>
